<h2>{{'movies.header' | translate}}:</h2>

<ng-container *ngIf="movies">
  <div class="filters">
    <!-- Input Filter -->
    <div class="filter-item">
      <mat-form-field>
        <input matInput type="search" placeholder="{{'movies.filter.placeholder' | translate}}" [(ngModel)]="filter"
          (keyup)="paginator.firstPage(); onSearch();" />
      </mat-form-field>
      <span *ngIf="filter" (click)="filter=''; paginator.firstPage(); onSearch();" class="pointer clear-btn">
        <fa-icon [icon]="['far', 'times-circle']" size="lg"></fa-icon>
      </span>
    </div>
    <!-- Genres Filter -->
    <div class="filter-item">
      <mat-form-field>
        <mat-select #select placeholder="{{'movies.filter.genres' | translate}}" multiple [(value)]="filteredGenres"
          (selectionChange)="paginator.firstPage(); filteredGenres = $event.value; onFilterGenres($event.value)">
          <mat-option *ngFor="let genre of genres" [value]="genre.id">{{genre.name}}</mat-option>
        </mat-select>
      </mat-form-field>
      <span *ngIf="filteredGenres" class="pointer clear-btn" (click)="paginator.firstPage(); filteredGenres = null; onFilterGenres(null)">
        <fa-icon [icon]="['far', 'times-circle']" size="lg"></fa-icon>
      </span>
    </div>
  </div>
  <div class="tags-search">
    <app-search-tag (selected)="selectedTag = $event"></app-search-tag>
    <button type="button" class="btn btn-outline-primary" [style.background]="selectedTag.color" *ngIf="selectedTag"
      (click)="addTag()">
      {{'movies.add_tag' |translate:{tag: selectedTag.label, size: nbChecked} }}
    </button>
    <span *ngIf="selectedTag" class="pointer clear-btn" (click)="selectedTag = undefined">
      <fa-icon [icon]="['far', 'times-circle']" size="lg"></fa-icon>
    </span>
  </div>

  <!-- Delete -->
  <div class="delete-btn">
    <button *ngIf="nbChecked > 0" class="btn btn-outline-primary" (click)="remove()">{{'movies.remove' |
      translate:{size: nbChecked} }}
      <fa-icon [icon]="faTrash"></fa-icon>
    </button>
  </div>

  <div class="paginator mat-elevation-z4">
    <!-- Paginator -->
    <mat-paginator #paginator [length]="length" [pageIndex]="pageIndex" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions"
      (page)="page = $event; onPaginateChange();" [showFirstLastButtons]="true">
    </mat-paginator>
  </div>

  <!-- Table -->
  <mat-table class="mat-elevation-z4" [dataSource]="displayedData" (matSortChange)="paginator.firstPage(); sort = $event; onSort();"
    matSort [matSortActive]="'date'" [matSortDirection]="'desc'" multiTemplateDataRows>

    <!-- ID -->
    <ng-container matColumnDef="id">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'movies.id'|translate }}">
        <span class="mat-text">{{ 'movies.id'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faHashtag"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.id}}
      </mat-cell>
    </ng-container>

    <!-- POSTER -->
    <ng-container matColumnDef="thumbnail">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'movies.poster'|translate }}">
        <span class="mat-text">{{ 'movies.poster'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faImage"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        <img class="movie-poster" src="{{movie.translation?.get(translate.currentLang)?.poster | image:'medium'}}" />
      </mat-cell>
    </ng-container>

    <!-- TITLE -->
    <ng-container matColumnDef="title">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'movies.title'|translate }}">
        <span class="mat-text">{{ 'movies.title'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faFilm"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.translation?.get(translate.currentLang)?.name}}
      </mat-cell>
    </ng-container>

    <!-- VO TITLE -->
    <ng-container matColumnDef="original_title">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'global.original_title'|translate }}">
        <span class="mat-text">{{ 'global.original_title'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faFlag"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.original_title}}
      </mat-cell>
    </ng-container>

    <!-- DATE -->
    <ng-container matColumnDef="date">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'movies.date'|translate }}">
        <span class="mat-text">{{ 'movies.date'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faCalendar"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.date | date:'MM/yyyy'}}
      </mat-cell>
    </ng-container>

    <!-- NOTE -->
    <ng-container matColumnDef="note">
      <mat-header-cell *matHeaderCellDef mat-sort-header start='desc' matTooltip="{{ 'movies.rating'|translate }}">
        <span class="mat-text">{{ 'movies.rating'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faStar"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.note}}
      </mat-cell>
    </ng-container>

    <!-- METACRITIC -->
    <ng-container matColumnDef="meta">
      <mat-header-cell *matHeaderCellDef mat-sort-header start='desc' matTooltip="{{ 'movies.rating'|translate }}">
        <span class="mat-text">{{ 'movies.rating'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faStar"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        <ng-container *ngIf="movie.score">
          <ng-container *ngFor="let rating of movie.score.ratings">
            <ng-container *ngIf="rating.Source === 'Metacritic'">
              {{rating.Value}}
            </ng-container>
          </ng-container>
        </ng-container>
      </mat-cell>
    </ng-container>

    <!-- LANGUE -->
    <ng-container matColumnDef="language">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'movies.language'|translate }}">
        <span class="mat-text">{{ 'movies.language'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faGlobe"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.language | uppercase}}
      </mat-cell>
    </ng-container>

    <!-- GENRES -->
    <ng-container matColumnDef="genres">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'global.genres'|translate }}">
        <span class="mat-text">{{ 'global.genres'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="faList"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        <ng-container *ngIf="movie.translation?.get(translate.currentLang)?.category as genres">
          <ng-container *ngFor="let genre of genres; let last=last">
            {{genre.name}}
            <ng-container *ngIf="!last">/</ng-container>
          </ng-container>
        </ng-container>
      </mat-cell>
    </ng-container>

    <!-- TIME -->
    <ng-container matColumnDef="time">
      <mat-header-cell *matHeaderCellDef mat-sort-header matTooltip="{{ 'movies.length'|translate }}">
        <span class="mat-text">{{ 'movies.length'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="['far', 'clock']"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.time | convertToHHmm:'true'}}
      </mat-cell>
    </ng-container>

    <!-- ADDED -->
    <ng-container matColumnDef="added">
      <mat-header-cell *matHeaderCellDef mat-sort-header start='desc' matTooltip="{{ 'movies.added'|translate }}">
        <span class="mat-text">{{ 'movies.added'|translate }}</span>
        <fa-icon class="mat-icon" [icon]="['far', 'clock']"></fa-icon>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie">
        {{movie.added | date:'dd/MM/yy HH:mm:ss'}}
      </mat-cell>
    </ng-container>

    <!-- Checkbox Column -->
    <ng-container matColumnDef="select">
      <mat-header-cell *matHeaderCellDef>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie" class="toto">
        <div class="cell-content">
          <mat-checkbox (change)="movie.checked = !movie.checked; updateSize()" (click)="$event.stopPropagation()"
            [checked]="movie.checked">
          </mat-checkbox>
        </div>
      </mat-cell>
    </ng-container>

    <!-- Details Column -->
    <ng-container matColumnDef="details">
      <mat-header-cell *matHeaderCellDef>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie" class="toto">
        <div class="cell-content">
          <button class="btn btn-outline-primary btn-detail" appOpenLink [label]="movie.translation?.get(translate.currentLang)?.name" url="/movie/{{movie.id}}"
            matTooltip="{{'global.go_detail' | translate}}">
            <span class="btn-text">
              <fa-icon [icon]="faChevronCircleRight"></fa-icon>
              {{'global.go_detail' | translate}}
            </span>
            <span class="btn-icon">
              <fa-icon [icon]="faChevronCircleRight" size="2x"></fa-icon>
            </span>
          </button>
        </div>
      </mat-cell>
    </ng-container>

    <ng-container matColumnDef="tag-icon">
      <mat-header-cell *matHeaderCellDef>
      </mat-header-cell>
      <mat-cell *matCellDef="let movie" class="tag-icon bounce">
        <fa-icon [icon]="faAngleDown" size="3x"></fa-icon>
      </mat-cell>
    </ng-container>

    <!-- TAGS -->
    <ng-container matColumnDef="{{expandedColumn}}">
      <td mat-cell *matCellDef="let movie" class="tag-detail" [attr.colspan]="displayedColumns.length" [@detailExpand]="movie == expandedElement ? 'expanded' : 'collapsed'">
        <ng-container *ngIf="movie == expandedElement">
          <h5 class="tags-header">{{'tags.header'|translate}}:</h5>
          <app-list-tags [tags]="displayedTags | async" [movieId]="movie.id"></app-list-tags>
        </ng-container>
      </td>
    </ng-container>

    <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
    <mat-row *matRowDef="let element; let i = dataIndex; columns: displayedColumns;" class="movie-row"
      [class.example-expanded-row]="expandedElement === element" (click)="expand(element)" [ngClass]="{'adult': element.adult}">
    </mat-row>
    <mat-row *matRowDef="let row; let i = dataIndex; columns: [expandedColumn];" class="tag-row"></mat-row>

  </mat-table>
</ng-container>
